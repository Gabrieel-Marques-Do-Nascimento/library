<div class="row mb-2" *ngIf="supportInfo">
  <div class="col-12 d-flex justify-content-end">
    <scl-command-games
      [supportInfo]="supportInfo"
      [extension]="extension"
      [command]="command"
    ></scl-command-games>
  </div>
</div>

<h5>
  {{
    (isNew ? "ui.commandEditor.titleNew" : "ui.commandEditor.title") | translate
  }}
</h5>

<hr />

<div class="row mb-2 pr-5 position-relative">
  <div class="col-12 flex-row d-flex justify-content-end">
    <button
      *ngIf="canClone()"
      [disabled]="isInvalid"
      class="btn btn-outline-secondary mr-2 dropdown-toggle"
      data-toggle="dropdown"
      data-offset="0,0"
      aria-haspopup="true"
      aria-expanded="false"
    >
      {{ "ui.shared.clone" | translate }}
    </button>
    <div class="dropdown-menu">
      <span
        class="dropdown-item"
        *ngFor="let target of cloneTargets"
        (click)="cloneCommand(target.value)"
        >{{ target.name }}</span
      >
    </div>
    <button class="btn btn-outline-secondary text-nowrap" (click)="addInput()">
      {{ "ui.commandEditor.addInput" | translate }}
    </button>
  </div>

  <button
    class="close delete-command-button text-danger"
    (click)="deleteCommand()"
    [title]="'ui.commandEditor.deleteCommand' | translate"
  >
    <ng-container *ngTemplateOutlet="deleteIcon"></ng-container>
  </button>
</div>

<div class="row mb-2">
  <div class="col-12 col-xl-4">
    <div class="input-group">
      <span class="input-group-text">{{
        "ui.commandEditor.fieldOpcode" | translate
      }}</span>
      <input
        type="text"
        class="form-control"
        maxlength="4"
        (blur)="opcodify(command)"
        [ngModel]="command.id"
        (ngModelChange)="onOpcodeChange(command, $event)"
        [ngClass]="{
          'is-invalid': isDirty && errors.emptyOpcode
        }"
      />
    </div>
  </div>
  <div class="col-12 col-xl-8">
    <div class="input-group">
      <span class="input-group-text d-none d-md-inline">{{
        "ui.commandEditor.fieldCommandLong" | translate
      }}</span>
      <span class="input-group-text d-inline d-md-none">{{
        "ui.commandEditor.fieldCommandShort" | translate
      }}</span>
      <input
        type="text"
        class="form-control"
        [ngModel]="command.name | uppercase"
        (ngModelChange)="onCommandNameChange(command, $event)"
        [ngClass]="{
          'is-invalid': isDirty && errors.emptyName
        }"
      />
    </div>
  </div>
</div>

<div class="row mb-2">
  <div class="col-12">
    <scl-selector
      [label]="'ui.commandEditor.fieldExtension' | translate"
      [model]="extension"
      (modelChange)="onExtensionChange($event)"
      [choices]="extensionNames"
    ></scl-selector>
  </div>
</div>

<div class="row mb-2">
  <div class="col-12 col-md-6">
    <div class="input-group">
      <scl-selector
        class="flex-grow-1"
        [model]="command.class"
        [label]="'ui.commandEditor.fieldClass' | translate"
        (modelChange)="onClassChange(command, $event)"
        [choices]="classes"
        [canInput]="true"
        [disabled]="command.attrs?.is_keyword || command.attrs?.is_nop"
      ></scl-selector>
    </div>
    <div
      class="mb-1"
      *ngIf="
        !command.attrs?.is_keyword &&
        !command.attrs?.is_nop &&
        !command.class &&
        suggestedClassName
      "
    >
      <small
        >{{ "ui.commandEditor.suggestion" | translate }}:
        <a
          href="#"
          (click)="(command.class = suggestedClassName) && updateErrors()"
          >{{ suggestedClassName }}</a
        ></small
      >
    </div>
  </div>
  <div class="col-12 col-md-6">
    <div class="input-group">
      <span class="input-group-text">{{
        "ui.commandEditor.fieldMember" | translate
      }}</span>
      <input
        type="text"
        [disabled]="
          command.attrs?.is_keyword || command.attrs?.is_nop || !command.class
        "
        class="form-control"
        [ngModel]="command.member"
        (ngModelChange)="onMemberChange(command, $event)"
      />
    </div>
    <div
      class="mb-1"
      *ngIf="
        !command.attrs?.is_keyword &&
        !command.attrs?.is_nop &&
        !command.member &&
        suggestedClassMember
      "
    >
      <small
        >{{ "ui.commandEditor.suggestion" | translate }}:
        <a
          href="#"
          (click)="(command.member = suggestedClassMember) && updateErrors()"
        >
          {{ suggestedClassMember }}</a
        ></small
      >
    </div>
  </div>
</div>

<div class="row mb-2">
  <div class="col-12">
    <div class="input-group">
      <span class="input-group-text d-none d-md-inline">{{
        "ui.commandEditor.fieldShortDescriptionLong" | translate
      }}</span>
      <span class="input-group-text d-inline d-md-none">{{
        "ui.commandEditor.fieldShortDescriptionShort" | translate
      }}</span>
      <input
        type="text"
        [ngModel]="command.short_desc"
        (ngModelChange)="onShortDescriptionChange(command, $event)"
        class="form-control"
        [disabled]="command.attrs?.is_nop"
      />
    </div>
  </div>
</div>

<ng-container cdkDropListGroup>
  <div
    cdkDropList
    [cdkDropListData]="command.input"
    [ngClass]="{ 'empty-list': !command.input.length }"
    (cdkDropListDropped)="drop($event, SourceType.any)"
  >
    <h5>{{ "ui.commandEditor.paramsSubtitle" | translate }}</h5>
    <div
      class="row mb-2 pr-5 position-relative"
      *ngFor="let param of command.input; let i = index"
      cdkDrag
      cdkDragBoundary="scl-command-editor"
    >
      <div class="col-12 col-lg-4">
        <div class="input-group">
          <span class="input-group-text" cdkDragHandle>{{ i + 1 }}</span>
          <ng-container
            *ngTemplateOutlet="paramTemplate; context: { param: param }"
          ></ng-container>
        </div>
        <div
          class="mb-1"
          *ngIf="getSuggestedInputName(i) as suggestedInputName"
        >
          <small
            >{{ "ui.commandEditor.suggestion" | translate }}:
            <a
              href="#"
              (click)="(param.name = suggestedInputName) && updateErrors()"
            >
              {{ suggestedInputName }}</a
            ></small
          >
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4">
        <scl-selector
          [ngClass]="{ invalid: param.type === PrimitiveType.any }"
          [(model)]="param.type"
          [choices]="paramTypes"
          (keydown)="onTypeKeyDown($event, param)"
          [canInput]="false"
        ></scl-selector>
        <div
          class="mb-1"
          *ngIf="getSuggestedInputType(i) as suggestedInputType"
        >
          <small
            >{{ "ui.commandEditor.suggestion" | translate }}:
            <a
              href="#"
              (click)="(param.type = suggestedInputType) && updateErrors()"
            >
              {{ suggestedInputType }}</a
            ></small
          >
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4">
        <scl-selector
          [model]="getDefaultInputSource(param)"
          (modelChange)="onParamSourceUpdate($event, param)"
          [choices]="sources"
          [canInput]="false"
          [narrowDropdown]="true"
        ></scl-selector>
      </div>

      <button
        class="close delete-param-button"
        (click)="deleteInput(i)"
        [title]="'ui.commandEditor.deleteParam' | translate"
      >
        <ng-container *ngTemplateOutlet="deleteIcon"></ng-container>
      </button>
    </div>
  </div>

  <div
    cdkDropList
    [cdkDropListData]="command.output"
    [ngClass]="{ 'empty-list': !command.output.length }"
    (cdkDropListDropped)="drop($event, SourceType.var_any)"
  >
    <h5>{{ "ui.commandEditor.resultSubtitle" | translate }}</h5>
    <div
      class="row mb-2 pr-5 position-relative"
      *ngFor="let param of command.output; let i = index"
      cdkDrag
      cdkDragBoundary="scl-command-editor"
    >
      <div class="col-12 col-lg-4">
        <div class="input-group">
          <span class="input-group-text" cdkDragHandle>{{ i + 1 }}</span>
          <ng-container
            *ngTemplateOutlet="paramTemplate; context: { param: param }"
          ></ng-container>
        </div>
        <div
          class="mb-1"
          *ngIf="getSuggestedOutputName(i) as suggestedOutputName"
        >
          <small
            >{{ "ui.commandEditor.suggestion" | translate }}:
            <a
              href="#"
              (click)="(param.name = suggestedOutputName) && updateErrors()"
            >
              {{ suggestedOutputName }}</a
            ></small
          >
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4">
        <scl-selector
          [ngClass]="{ invalid: param.type === PrimitiveType.any }"
          [(model)]="param.type"
          [choices]="paramTypes"
          (keydown)="onTypeKeyDown($event, param)"
          [canInput]="
            command.attrs?.is_constructor && i === command.output.length - 1
          "
        ></scl-selector>
        <div
          class="mb-1"
          *ngIf="getSuggestedOutputType(i) as suggestedOutputType"
        >
          <small
            >{{ "ui.commandEditor.suggestion" | translate }}:
            <a
              href="#"
              (click)="(param.type = suggestedOutputType) && updateErrors()"
            >
              {{ suggestedOutputType }}</a
            ></small
          >
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4">
        <scl-selector
          [model]="getDefaultOutputSource(param)"
          (modelChange)="onParamSourceUpdate($event, param)"
          [choices]="sources"
          [canInput]="false"
        ></scl-selector>
        <div
          class="mb-1"
          *ngIf="getSuggestedOutputSource(i) as suggestedOutputSource"
        >
          <small
            >{{ "ui.commandEditor.suggestion" | translate }}:
            <a
              href="#"
              (click)="
                onParamSourceUpdate(suggestedOutputSource, param) || false
              "
            >
              {{ suggestedOutputSource }}</a
            ></small
          >
        </div>
      </div>

      <button
        class="close delete-param-button"
        (click)="deleteOutput(i)"
        [title]="'ui.commandEditor.deleteParam' | translate"
      >
        <ng-container *ngTemplateOutlet="deleteIcon"></ng-container>
      </button>
    </div>
  </div>
</ng-container>

<div class="row mb-2">
  <div class="col-12">
    <div class="d-inline-block pr-2" *ngFor="let attr of attrs">
      <label
        class="form-check-label"
        [title]="'ui.attributes.' + attr | translate"
      >
        <input
          type="checkbox"
          [ngModel]="command.attrs ? command.attrs[attr] : undefined"
          (ngModelChange)="onAttrChange(command, attr, $event)"
        />
        <span class="checkbox"></span>
        {{ attr }}
      </label>
    </div>

    <div class="alert alert-danger mt-3" *ngIf="isInvalid && isDirty">
      <div *ngFor="let message of errorMessages">
        {{ message | translate }}
      </div>
    </div>
  </div>
</div>

<div class="row mb-2">
  <div class="col-12">
    <div class="form-group">
      <label [for]="command.id + '_snippet'" class="h5">{{
        "ui.commandEditor.codeSnippetSubtitle" | translate
      }}</label>
      <textarea
        class="form-control"
        rows="4"
        [id]="command.id + '_snippet'"
        [ngModel]="snippet"
        (ngModelChange)="onSnippetChange($event)"
      ></textarea>
    </div>
  </div>
</div>

<ng-template #paramTemplate let-param="param" let-i="i">
  <input
    type="text"
    class="form-control"
    [ngModel]="param.name"
    (ngModelChange)="onParamNameChange($event, param)"
    [ngClass]="{ 'is-invalid': isParamNameDuplicate(param.name) }"
  />
</ng-template>

<ng-template #deleteIcon>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="16"
    height="16"
    fill="currentColor"
    class="bi bi-trash"
    viewBox="0 0 16 16"
  >
    <path
      d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"
    />
    <path
      fill-rule="evenodd"
      d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"
    />
  </svg>
</ng-template>
